<div class="general-visual">
  <div class="container pt-5">
    <div class="d-flex justify-content-between">
      <h2 class="border-bottom mb-3">地方移住に関する最新のニュース</h2>
      <h5>Powered by <%= link_to "https://newsapi.org" do %><span class="link">News API</span><% end %></h5>
    </div>
    <div class="d-flex justify-content-between align-items-center">
      <i class="fas fa-chevron-left fa-3x arrow" size="5x"></i>
      <div id="japan-map" class="my-5"></div>
      <i class="fas fa-chevron-right fa-3x arrow"></i>
    </div>
    <%= render partial: "data", collection: @news, as: "news" %>
  </div>
</div>

<script>
  // ヒートマップで表現する数値データを定義している部分
  function defineData(){
    const data = {
      "date" : "2020/08/27",
      "total_patient_person_number": 65769,
      "new_patient_person_number": 865,
      "prefectures" : <%= @prefecture_data[0].map{ |n| n.to_i } %>
      // [10,2,0,1,0,0,7,8,1,18,69,45,250,66,1,8,13,13,0,6,2,12,39,6,5,27,94,22,4,0,0,0,1,1,6,4,0,0,0,64,2,7,6,1,1,2,36]
    }
    return data
  }

  // 表示する色を作っている部分
  function prefecturesConvertRGB(prefecture){
    function heatMapColorforValue(value){
      var h = (1.0 - value) * 240
      return "hsl(" + h + ", 100%, 50%)";
    }
    return heatMapColorforValue(prefecture)
  }

  // 今回の数値データを0〜1の範囲に変換している部分
  function nomalizePrefectures(prefectures, new_patient_person_number){
    const max = Math.max(...prefectures)
    const prefs = prefectures.map(function(x){
      return x / max;
    })
    return prefs
  }

  // {"code": ... , "color": ...}のjsonオブジェクトの配列を作成している部分
  function defineAreas(data){
    let areas = []
    const prefectures = nomalizePrefectures(data.prefectures, data.new_patient_person_number)
    for (let i=1;i<=47;i++) {
      areas.push(
        {
          "code": i,
          "color": prefecturesConvertRGB(prefectures[i-1])
        }
      )
    }
    return areas
  }

  // ヒートマップを表示する部分
  function main(){
    const data = defineData()
    const areas = defineAreas(data)

    const d = new jpmap.japanMap(document.getElementById("japan-map"), {
      areas: areas,
      width: 800,
      lineWidth: 0,
      drawsBoxLine : false,
      movesIslands : true,
      onSelect: function(data){
        alert(data.name);
      }
    });
  }

  main()
</script>
